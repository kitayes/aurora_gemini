# Работа с большими объемами контекста в Aurora Bot

## Проблема

При наличии тысяч символов информации о мире возникает вопрос: как дать боту доступ ко всем этим знаниям?

**Ограничения:**
- Context window LLM ограничен (~8k-32k токенов)
- Большие chunks дают менее точные embeddings
- Традиционные JSON chunks слишком малы

## Решения

### ✅ 1. Hierarchical Chunking (Рекомендуется)

**Идея:** Разбиваем большой документ на иерархию уровней.

```
Большой документ "История Авроры" (10,000 символов)
├── Summary (300 символов) - краткое содержание
├── Раздел 1: Основание империи (2,000 символов)
│   ├── Подраздел 1.1 (800 символов)
│   └── Подраздел 1.2 (800 символов)
├── Раздел 2: Война магов (3,000 символов)
│   ├── Подраздел 2.1 (1,000 символов)
│   └── Подраздел 2.2 (1,000 символов)
└── Раздел 3: Современность (2,000 символов)
```

**Как работает:**
1. При запросе сначала находится Summary (быстрый обзор)
2. Если summary релевантен, ищутся конкретные разделы
3. Бот получает и общий контекст, и детали

### 2. Paragraph Chunking

**Для средних документов (2,000-5,000 символов)**

Разбивает по абзацам с перекрытием:

```
Chunk 1: Абзацы 1-3 (1000 символов)
Chunk 2: Абзацы 3-6 (1000 символов) ← перекрытие с chunk 1
Chunk 3: Абзацы 6-9 (1000 символов)
```

**Преимущества:**
- Сохраняется контекст между chunks
- Не обрезаются предложения посередине
- Overlap (перекрытие) предотвращает потерю связи

### 3. Sentence Chunking

**Для структурированного текста**

Разбивает по предложениям, группируя их в chunks оптимального размера.

## Практическое использование

### Способ 1: Через RAG Service API (программно)

```go
import "aurora/internal/rag"

// Для большого документа
err := ragService.IndexFromText(
    ctx,
    "history_aurora",               // ID документа
    "История мира Аврора",          // Заголовок
    hugeText,                        // 10,000+ символов
    "world",                         // Zone
    []string{"история", "империя"}, // Tags
)

// Автоматически выберет стратегию:
// - < 2000 символов → целиком
// - 2000-5000 → paragraph chunking
// - > 5000 → hierarchical chunking
```

### Способ 2: Через текстовые файлы

#### Создайте структуру файлов:

```
lore/
├── extended/
│   ├── history_full.txt          # Полная история (10,000 символов)
│   ├── magic_system_detailed.txt # Детальная магия (15,000 символов)
│   └── economy_deep_dive.txt     # Подробная экономика (8,000 символов)
```

#### Создайте скрипт для индексации:

```go
// cmd/index_large/main.go
package main

import (
    "context"
    "fmt"
    "os"
    "path/filepath"
    "strings"
    
    "aurora/internal/embeddings"
    "aurora/internal/lore"
    "aurora/internal/rag"
    "aurora/internal/repository"
    "aurora/pkg/config"
)

func main() {
    cfg, _ := config.Load()
    db, _ := repository.NewSQLite(cfg.DBPath)
    defer db.Close()
    
    loreRepo, _ := lore.NewFileLoreRepo("lore")
    embedder := embeddings.NewGeminiEmbedder(cfg.GeminiKey)
    vectorRepo := repository.NewVectorRepository(db)
    ragService := rag.NewService(embedder, vectorRepo, loreRepo)
    
    ctx := context.Background()
    
    // Индексируем большие текстовые файлы
    files, _ := filepath.Glob("lore/extended/*.txt")
    
    for _, file := range files {
        content, _ := os.ReadFile(file)
        filename := filepath.Base(file)
        docID := strings.TrimSuffix(filename, ".txt")
        
        fmt.Printf("Индексирую: %s (%d символов)\\n", filename, len(content))
        
        err := ragService.IndexFromText(
            ctx,
            docID,
            docID,
            string(content),
            "extended_lore",
            []string{"подробный", "детальный"},
        )
        
        if err != nil {
            fmt.Printf("Ошибка: %v\\n", err)
        } else {
            fmt.Println("✅ Готово!")
        }
    }
}
```

### Способ 3: Markdown файлы с разделами

**Создайте структурированный markdown:**

```markdown
# История Империи Аврора

## Основание (2000 лет назад)

Империя Аврора была основана группой магов-изгнанников...
[длинный текст]

## Золотой век

В период рассвета империя контролировала...
[длинный текст]

## Тёмные времена

Война магов началась с предательства...
[длинный текст]
```

**Индексация:**

```go
content, _ := os.ReadFile("lore/history_detailed.md")

err := ragService.IndexLargeDocument(
    ctx,
    "history_empire",
    "История Империи Аврора",
    string(content),
    "history",
    []string{"история", "империя", "война"},
    rag.StrategyHierarchical,  // Автоматически разобьет по ##
)
```

## Примеры стратегий

### Пример 1: Небольшой документ (< 2000 символов)

```json
{
  "title": "Гильдия торговцев",
  "content": "Краткое описание на 500 символов...",
  "zone": "economy",
  "tags": ["торговля", "гильдия"]
}
```

**Результат:** 1 chunk, хранится целиком.

---

### Пример 2: Средний документ (2000-5000 символов)

**Файл:** `magic_basics.txt` (3000 символов)

```
Магическая система Авроры основана на трёх столпах...

[Абзац 1-3: 1000 символов]
[Абзац 4-6: 1000 символов]
[Абзац 7-10: 1000 символов]
```

**Стратегия:** Paragraph Chunking

**Результат:**
- Chunk 1: Абзацы 1-3 + начало 4 (overlap)
- Chunk 2: Конец 3 + абзацы 4-6 + начало 7 (overlap)
- Chunk 3: Конец 6 + абзацы 7-10

---

### Пример 3: Большой документ (> 5000 символов)

**Файл:** `world_encyclopedia.md` (15,000 символов)

```markdown
# Энциклопедия мира Аврора

## География
### Континенты
[2000 символов]

### Климат
[1500 символов]

## Расы и народы
### Люди
[2000 символов]

### Эльфы
[2000 символов]

## Магия
[3000 символов]
```

**Стратегия:** Hierarchical Chunking

**Результат:**
- **Summary chunk:** "Энциклопедия мира Аврора - краткий обзор..." (300 символов)
- **Section 1:** География → Континенты (2000 символов)
- **Section 2:** География → Климат (1500 символов)
- **Section 3:** Расы → Люди (2000 символов)
- **Section 4:** Расы → Эльфы (2000 символов)
- **Section 5:** Магия (3000 символов, может быть разбит дальше)

**Преимущества:**
1. Summary находится первым при поиске → быстрый контекст
2. Если нужны детали о "магии" → находится Section 5
3. Если нужны "эльфы" → находится Section 4
4. Бот получает ровно ту информацию, которая нужна

## Как это улучшает контекст

### Сравнение

**Старый подход:**
```
Вопрос: "Расскажи про эльфов Авроры"
Найдено: 1 chunk "Общая информация о мире" (ничего про эльфов)
Результат: ❌ Неточный ответ
```

**Новый подход с hierarchical chunking:**
```
Вопрос: "Расскажи про эльфов Авроры"
Найдено:
  1. Summary: "Энциклопедия мира..." (cosine sim: 0.75)
  2. Section "Эльфы": детальная информация (cosine sim: 0.92) ✅
  3. Section "Расы и народы": общая информация (cosine sim: 0.85)

Бот получает: краткий обзор + детали об эльфах
Результат: ✅ Точный, подробный ответ
```

## Рекомендации

### 1. Размеры chunks

| Тип контента | Рекомендуемый размер | Стратегия |
|--------------|----------------------|-----------|
| Краткие справки | 200-500 символов | Целиком |
| Описания локаций | 500-1500 символов | Целиком |
| Детальный лор | 1500-3000 символов | Paragraph |
| Энциклопедии | 5000+ символов | Hierarchical |
| Романы, истории | 10000+ символов | Hierarchical |

### 2. Overlap (перекрытие)

**Рекомендуется:** 200 символов

Это ~2-3 предложения, предотвращает потерю контекста между chunks.

### 3. Количество результатов

```go
// Для обычных вопросов
options := rag.RetrievalOptions{
    Limit: 5,
}

// Для Сферы Лапидария (нужно больше контекста)
options := rag.RetrievalOptions{
    Limit: 7,
}

// Для сложных энциклопедических вопросов
options := rag.RetrievalOptions{
    Limit: 10,  // но учтите лимит токенов LLM
}
```

### 4. Структура файлов

```
lore/
├── core.json              # Базовый лор (коротко)
├── economy.json           # Экономика (коротко)
├── extended/              # Большие документы
│   ├── history_full.md   # История (10k символов)
│   ├── magic_deep.md     # Магия (15k символов)
│   └── races_detailed.md # Расы (12k символов)
└── quick_ref/             # Быстрые справки
    ├── locations.json
    └── npcs.json
```

## CLI команды

### Индексация одного большого файла

```bash
go run cmd/index_large/main.go lore/extended/history_full.md world история,империя
```

### Индексация всей папки

```bash
go run cmd/index_large/main.go --dir lore/extended --zone extended_lore
```

### Проверка статистики

```bash
go run cmd/indexer/main.go --stats

# Вывод:
# Total documents: 45
#   - summary chunks: 5
#   - section chunks: 25
#   - paragraph chunks: 15
```

## Performance

### Индексация большого документа (10,000 символов):

- Hierarchical chunking: ~10-12 chunks
- Embeddings: ~12 * 200ms = **2.4 секунды**
- Vector indexing: ~100ms
- **Общее время: ~2.5 секунды**

### Retrieval:

- Embedding запроса: ~200ms
- Vector search (45 документов): ~50ms
- **Общее время: ~250ms** (не изменилось!)

## Заключение

✅ **Используйте hierarchical chunking** для документов > 5000 символов  
✅ **Создавайте summary chunks** для быстрого обзора  
✅ **Держите chunks в пределах 1000-1500 символов** для точных embeddings  
✅ **Используйте overlap 200 символов** для сохранения контекста  
✅ **Индексируйте summary + sections** вместо одного огромного chunk

Теперь вы можете хранить **энциклопедии** lore, а бот будет находить именно ту информацию, которая нужна!

# RAG (Retrieval-Augmented Generation) –¥–ª—è Aurora Bot

## –û–ø–∏—Å–∞–Ω–∏–µ

RAG —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫** –ø–æ –∑–Ω–∞–Ω–∏—è–º –æ –º–∏—Ä–µ –≤–º–µ—Å—Ç–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ–≥–æ–≤–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤.

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

**–î–æ:**
- –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º (—Å—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
- –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã –∏ —Å–µ–º–∞–Ω—Ç–∏–∫—É
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å

**–ü–æ—Å–ª–µ:**
- –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ embeddings
- –ü–æ–Ω–∏–º–∞–µ—Ç —Å–º—ã—Å–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–∏–Ω–æ–Ω–∏–º—ã
- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- Automatic fallback –Ω–∞ —Ç–µ–≥–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   User      ‚îÇ
‚îÇ  Question   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LLM Client     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  RAG Service     ‚îÇ
‚îÇ (Gemini/OpenAI) ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
                                  ‚îÇ
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ                       ‚îÇ
                      ‚ñº                       ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   Embedding   ‚îÇ     ‚îÇ  Vector Repo    ‚îÇ
              ‚îÇ    Service    ‚îÇ     ‚îÇ   (SQLite)      ‚îÇ
              ‚îÇ  (Gemini API) ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Embedding Service (`internal/embeddings`)
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ Gemini API.
- Model: `text-embedding-004`
- Dimensions: 768
- –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π + –ê–Ω–≥–ª–∏–π—Å–∫–∏–π

### 2. Vector Repository (`internal/repository/vector_repo.go`)
–•—Ä–∞–Ω–∏—Ç –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ embeddings –≤ SQLite.
- Cosine similarity –¥–ª—è –ø–æ–∏—Å–∫–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (zone, tags)
- Batch –æ–ø–µ—Ä–∞—Ü–∏–∏

### 3. RAG Service (`internal/rag`)
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.
- Retrieval —Å fallback
- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è lore —Ñ–∞–π–ª–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### 4. Indexer (`cmd/indexer`)
CLI —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ lore –±–∞–∑—ã.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü–µ—Ä–≤–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è lore

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:

```bash
go run cmd/indexer/main.go
```

–í—ã–≤–æ–¥:
```
üîç Aurora Lore Indexer
====================
‚úÖ Connected to database
‚úÖ Loaded lore repository
‚úÖ Initialized embedding service
‚úÖ Initialized vector repository
‚úÖ Initialized RAG service
üìö Indexing lore...
‚úÖ Indexing complete!
   Total documents: 5
   Documents by zone:
     - world: 1
     - economy: 1
     - regions: 1
```

### –†–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ lore)

```bash
go run cmd/indexer/main.go --reindex
```

–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ.

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ lore

1. –î–æ–±–∞–≤—å—Ç–µ JSON —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É `lore/`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:
   ```bash
   go run cmd/indexer/main.go --reindex
   ```

–§–æ—Ä–º–∞—Ç JSON —Ñ–∞–π–ª–∞:
```json
[
  {
    "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞–Ω–∫–∞",
    "content": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ...",
    "zone": "magic",
    "tags": ["–º–∞–≥–∏—è", "–∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è", "—Ä—É–Ω—ã"]
  }
]
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç RAG –≤ –±–æ—Ç–µ

### –ü—Ä–∏–º–µ—Ä 1: –í–æ–ø—Ä–æ—Å –∏–≥—Ä–æ–∫–∞

**–ó–∞–ø—Ä–æ—Å:** "–†–∞—Å—Å–∫–∞–∂–∏ –æ –≤–∞–ª—é—Ç–µ –≤ –º–∏—Ä–µ"

**–°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ (—Ç–µ–≥–∏):**
- –ò—â–µ—Ç —Ç–µ–≥ "–≤–∞–ª—é—Ç–∞" ‚Üí –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
- –ò—â–µ—Ç —Ç–µ–≥ "–¥–µ–Ω—å–≥–∏" ‚Üí –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ (RAG):**
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embedding –∑–∞–ø—Ä–æ—Å–∞
- –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: "–≠–∫–æ–Ω–æ–º–∏–∫–∞", "–¢–æ—Ä–≥–æ–≤–ª—è", "–ó–æ–ª–æ—Ç–æ"
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

### –ü—Ä–∏–º–µ—Ä 2: –°—Ñ–µ—Ä–∞ –õ–∞–ø–∏–¥–∞—Ä–∏—è

**–í–æ–ø—Ä–æ—Å:** "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–≥–∏—è –æ–≥–Ω—è?"

**RAG:**
1. Embedding –∑–∞–ø—Ä–æ—Å–∞
2. Semantic search –ø–æ –≤—Å–µ–º lore chunks
3. –ù–∞—Ö–æ–¥–∏—Ç: "–®–∫–æ–ª–∞ –æ–≥–Ω–µ–Ω–Ω–æ–π –º–∞–≥–∏–∏", "–ü–∏—Ä–æ–º–∞–Ω—Ç–∏—è", "–†—É–Ω—ã –æ–≥–Ω—è"
4. LLM –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
5. –î–∞–µ—Ç —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç

## –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

–ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞:

```sql
CREATE TABLE IF NOT EXISTS lore_vectors (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    zone TEXT NOT NULL,
    tags TEXT NOT NULL,
    vector BLOB NOT NULL,
    metadata TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_lore_vectors_zone ON lore_vectors(zone);
```

## Performance

### Benchmarks (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)

- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è embedding:** ~150-200ms
- **Vector search:** ~30-50ms
- **–û–±—â–µ–µ –≤—Ä–µ–º—è retrieval:** ~200-300ms

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

–ï—Å–ª–∏ RAG —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ:

1. **–£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
   ```go
   ragService.RetrieveRelevant(ctx, query, rag.RetrievalOptions{
       Limit: 3,  // –≤–º–µ—Å—Ç–æ 5
   })
   ```

2. **–î–æ–±–∞–≤—å—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (–±—É–¥—É—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ batch embedding** –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

## Troubleshooting

### –û—à–∏–±–∫–∞: "empty text provided"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ lore —Ñ–∞–π–ª—ã –Ω–µ –ø—É—Å—Ç—ã–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON

### –û—à–∏–±–∫–∞: "API error"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Gemini API key
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–∏–º–∏—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω—ã (1500 req/day)

### RAG –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: "RAG service enabled for semantic search"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å
- –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é

### –í–µ–∫—Ç–æ—Ä—ã –Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è `010_vector_lore.sql` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

## Roadmap

–ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

- [ ] **Hybrid Search** - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ + BM25
- [ ] **Reranking** - –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ LLM
- [ ] **Context Compression** - —Å–∂–∞—Ç–∏–µ –¥–ª–∏–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- [ ] **Query Expansion** - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏
- [ ] **Caching** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö embeddings
- [ ] **Monitoring** - –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ RAG

## API Reference

### RAG Service

```go
type Service struct {
    embedder   embeddings.Service
    vectorRepo repository.VectorRepository
    loreRepo   lore.Repository
}

// RetrieveRelevant - –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
func (s *Service) RetrieveRelevant(
    ctx context.Context,
    query string,
    options RetrievalOptions,
) ([]lore.Chunk, error)

// IndexLore - –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å lore –±–∞–∑—É
func (s *Service) IndexLore(ctx context.Context) error

// ReindexAll - –ø–æ–ª–Ω–∞—è —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
func (s *Service) ReindexAll(ctx context.Context) error

// GetStats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
func (s *Service) GetStats(ctx context.Context) (repository.VectorStats, error)
```

### Retrieval Options

```go
type RetrievalOptions struct {
    Limit    int                // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (default: 5)
    Filters  map[string]string  // —Ñ–∏–ª—å—Ç—Ä—ã: zone, faction, tags
    MinScore float32            // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å (0.0-1.0)
}
```

## Credits

- **Vector DB:** SQLite with JSON vectors
- **Embeddings:** Google Gemini Text Embedding API
- **Search:** Cosine Similarity
- **Architecture:** Clean Architecture pattern
